name: main

on:
  push:
    branches:
      - master
  pull_request:
  release:

jobs:
  ocaml:
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-20.04
          - macos-12
        ocaml-compiler:
          - 4.12.1

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # get complete history, including tags for CPR_VERSION env

      - name: Use OCaml ${{ matrix.ocaml-compiler }}
        uses: ocaml/setup-ocaml@v2
        with:
          ocaml-compiler: ocaml-variants.${{ matrix.ocaml-compiler }}+options,ocaml-option-flambda
          opam-local-packages: ocaml/*.opam
          dune-cache: true

      - name: Install dependencies
        run: opam install cpr cpr-dev --deps-only --with-test

      - name: Run tests
        working-directory: ocaml
        run: |
          export CPR_VERSION=github_ci-${{ matrix.os }}-$(git describe --tags --dirty || git describe --all --long --dirty)
          opam exec -- dune build @fmt
          opam exec -- dune build
          opam exec -- dune runtest
          opam exec -- dune build --release

      - name: Upload the gym shared object
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.os }}-ocaml-${{ matrix.ocaml-compiler }}
          path: _build/default/ocaml/gym/bridge.so

  python:
    strategy:
      matrix:
        os:
          - ubuntu-20.04
          - ubuntu-22.04
        python-version:
          - 3.9

    needs: ocaml

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download gym shared object
        uses: actions/download-artifact@v3
        with:
          name: ubuntu-20.04-ocaml-4.12.1
          path: python/gym/cpr_gym

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        working-directory: python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        working-directory: python
        run: |
          black --check .
          flake8
          pytest --forked


  release:
    runs-on: ubuntu-latest

    needs: python

    if: github.event_name == 'release'

    steps:
      - name: Download gym shared object (linux)
        uses: actions/download-artifact@v3
        with:
          name: ubuntu-20.04-ocaml-4.12.1
          path: linux

      - name: Download gym shared object (macos)
        uses: actions/download-artifact@v3
        with:
          name: macos-12-ocaml-4.12.1
          path: macos

      - name: Upload linux binary to release
        uses: svenstaro/upload-release-action@v2
        with:
          file: 'linux/bridge.so'
          asset_name: 'cpr-$tag-linux.so'

      - name: Upload macos binary to release
        uses: svenstaro/upload-release-action@v2
        with:
          file: 'macos/bridge.so'
          asset_name: 'cpr-$tag-macos.so'
          prerelease: false
