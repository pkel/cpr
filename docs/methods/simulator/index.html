<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://pkel.github.io/cpr/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://pkel.github.io/cpr/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://pkel.github.io/cpr/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://pkel.github.io/cpr/fonts/KaTeX_Main-Regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://pkel.github.io/cpr/fonts/KaTeX_Math-Italic.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=https://pkel.github.io/cpr/main.90175f47a573116ff545dd9a211df08878637827e2490d7b0807bfda9e084a55263c538690897f6a475d9f5af71e2c517ace4345bcf2606df8471e8bbaeeb005.css integrity="sha512-kBdfR6VzEW/1Rd2aIR3wiHhjeCfiSQ17CAe/2p4ISlUmPFOGkIl/akddn1r3HixRes5DRbzyYG34Rx6Luu6wBQ==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Simulator - CPR</title><meta name=description content="How we simulate protocol executions.
"><link rel=canonical href=https://pkel.github.io/cpr/docs/methods/simulator/><meta property="og:locale" content><meta property="og:type" content="article"><meta property="og:title" content="Simulator"><meta property="og:description" content="How we simulate protocol executions.
"><meta property="og:url" content="https://pkel.github.io/cpr/docs/methods/simulator/"><meta property="og:site_name" content="CPR"><meta property="article:modified_time" content="2023-11-15T10:59:20+01:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content><meta name=twitter:creator content><meta name=twitter:title content="Simulator"><meta name=twitter:description content="How we simulate protocol executions.
"><meta name=twitter:card content="summary"><meta name=twitter:image:alt content="Simulator"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://pkel.github.io/#/schema/person/1","name":"CPR","url":"https://pkel.github.io/","sameAs":["https://github.com/pkel/cpr"],"image":{"@type":"ImageObject","@id":"https://pkel.github.io/#/schema/image/1","url":"https://pkel.github.io/\u003cnil\u003e","width":null,"height":null,"caption":"CPR"}},{"@type":"WebSite","@id":"https://pkel.github.io/#/schema/website/1","url":"https://pkel.github.io/","name":"CPR","description":"CPR provides tools for specifying, simulating, and attacking proof-of-work consensus protocols like Bitcoin and Ethereum.","publisher":{"@id":"https://pkel.github.io/#/schema/person/1"}},{"@type":"WebPage","@id":"https://pkel.github.io/cpr/docs/methods/simulator/","url":"https://pkel.github.io/cpr/docs/methods/simulator/","name":"Simulator","description":"How we simulate protocol executions.\n","isPartOf":{"@id":"https://pkel.github.io/#/schema/website/1"},"about":{"@id":"https://pkel.github.io/#/schema/person/1"},"datePublished":"0001-01-01T00:00:00CET","dateModified":"2023-11-15T10:59:20CET","breadcrumb":{"@id":"https://pkel.github.io/cpr/docs/methods/simulator/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://pkel.github.io/cpr/docs/methods/simulator/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://pkel.github.io/cpr/docs/methods/simulator/"]}]},{"@type":"BreadcrumbList","@id":"https://pkel.github.io/cpr/docs/methods/simulator/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://pkel.github.io/cpr/","url":"https://pkel.github.io/cpr/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://pkel.github.io/cpr/docs/","url":"https://pkel.github.io/cpr/docs/","name":"Docs"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://pkel.github.io/cpr/docs/methods/","url":"https://pkel.github.io/cpr/docs/methods/","name":"Methods"}},{"@type":"ListItem","position":4,"item":{"@id":"https://pkel.github.io/cpr/docs/methods/simulator/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://pkel.github.io/#/schema/article/1","headline":"Simulator","description":"How we simulate protocol executions.\n","isPartOf":{"@id":"https://pkel.github.io/cpr/docs/methods/simulator/"},"mainEntityOfPage":{"@id":"https://pkel.github.io/cpr/docs/methods/simulator/"},"datePublished":"0001-01-01T00:00:00CET","dateModified":"2023-11-15T10:59:20CET","author":{"@id":"https://pkel.github.io/#/schema/person/2"},"publisher":{"@id":"https://pkel.github.io/#/schema/person/1"},"image":{"@id":"https://pkel.github.io/cpr/docs/methods/simulator/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://pkel.github.io/#/schema/person/2","name":"Patrik Keller","sameAs":["https://github.com/pkel"]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://pkel.github.io/cpr/docs/methods/simulator/#/schema/image/2","url":null,"contentUrl":null,"caption":"Simulator"}]}]}</script><meta name=theme-color content="#fff"><link rel=icon href=https://pkel.github.io/cpr/favicon.ico sizes=any><link rel=apple-touch-icon sizes=180x180 href=https://pkel.github.io/cpr/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://pkel.github.io/cpr/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://pkel.github.io/cpr/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://pkel.github.io/cpr/site.webmanifest></head><body class="docs single"><div class=sticky-top><div class=header-bar></div><header class="navbar navbar-expand-lg navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/ aria-label=CPR>CPR</a>
<button class="btn btn-link order-0 ms-auto d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasExample aria-controls=offcanvasExample><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-horizontal"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg></button><div class="offcanvas offcanvas-start d-lg-none" tabindex=-1 id=offcanvasExample aria-labelledby=offcanvasExampleLabel><div class=header-bar></div><div class=offcanvas-header><h5 class=offcanvas-title id=offcanvasExampleLabel>Browse docs</h5><button type=button class=btn-close data-bs-dismiss=offcanvas aria-label=Close></button></div><div class=offcanvas-body><aside class="doks-sidebar mt-n3"><nav id=doks-docs-nav aria-label="Tertiary navigation"><ul class="list-unstyled collapsible-sidebar"><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-5f2cae171c6192fa410df4385f7218aa aria-expanded=false>
Prologue</button><div class=collapse id=section-5f2cae171c6192fa410df4385f7218aa><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/prologue/introduction/>Introduction</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/prologue/faq/>FAQ</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-2ba0c1d2f0f117d4512ef6170fe0e015 aria-expanded=true>
Methodology</button><div class="collapse show" id=section-2ba0c1d2f0f117d4512ef6170fe0e015><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/methods/virtual-environment/>Virtual Environment</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/methods/protocol-specification/>Protocol Specification</a></li><li><a class="docs-link rounded active" href=https://pkel.github.io/cpr/docs/methods/simulator/>Simulator</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-9985b4390c40137573e6da05caf85874 aria-expanded=false>
Protocols</button><div class=collapse id=section-9985b4390c40137573e6da05caf85874><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/overview/>Overview</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/nakamoto/>Nakamoto</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/parallel-simple/>Parallel PoW (simplified)</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/parallel-aft22/>Parallel PoW (AFTâ€‰'22)</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/parallel-tree/>Tree-Structured Voting</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/tailstorm/>Tailstorm</a></li></ul></div></li></ul></nav></aside></div></div><button class="btn btn-menu order-2 d-block d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-lg-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-lg-none"></div><div class="offcanvas-header d-lg-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/>CPR</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body p-4 p-lg-0"><ul class="nav flex-column flex-lg-row align-items-lg-center mt-2 mt-lg-0 ms-lg-2 me-lg-auto"><li class=nav-item><a class="nav-link ps-0 py-1 active" href=/cpr/docs/prologue/introduction/>Docs</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/cpr/blog/>Blog</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><form class="doks-search position-relative flex-grow-1 ms-lg-auto me-lg-2"><input id=search class="form-control is-search" type=search placeholder="Search docs..." aria-label="Search docs..." autocomplete=off><div id=suggestions class="shadow bg-white rounded d-none"></div></form><hr class="text-black-50 my-4 d-lg-none"><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=https://github.com/pkel/cpr><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-lg-none">GitHub</small></a></li></ul></div></div></nav></header></div><div class=container-xxl><aside class=doks-sidebar><nav id=doks-docs-nav class="collapse d-lg-none" aria-label="Tertiary navigation"><ul class="list-unstyled collapsible-sidebar"><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-5f2cae171c6192fa410df4385f7218aa aria-expanded=false>
Prologue</button><div class=collapse id=section-5f2cae171c6192fa410df4385f7218aa><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/prologue/introduction/>Introduction</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/prologue/faq/>FAQ</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-2ba0c1d2f0f117d4512ef6170fe0e015 aria-expanded=true>
Methodology</button><div class="collapse show" id=section-2ba0c1d2f0f117d4512ef6170fe0e015><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/methods/virtual-environment/>Virtual Environment</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/methods/protocol-specification/>Protocol Specification</a></li><li><a class="docs-link rounded active" href=https://pkel.github.io/cpr/docs/methods/simulator/>Simulator</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-9985b4390c40137573e6da05caf85874 aria-expanded=false>
Protocols</button><div class=collapse id=section-9985b4390c40137573e6da05caf85874><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/overview/>Overview</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/nakamoto/>Nakamoto</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/parallel-simple/>Parallel PoW (simplified)</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/parallel-aft22/>Parallel PoW (AFTâ€‰'22)</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/parallel-tree/>Tree-Structured Voting</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/tailstorm/>Tailstorm</a></li></ul></div></li></ul></nav></aside></div><div class="wrap container-xxl" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar d-none d-lg-block"><nav class=docs-links aria-label="Main navigation"><ul class="list-unstyled collapsible-sidebar"><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-5f2cae171c6192fa410df4385f7218aa aria-expanded=false>
Prologue</button><div class=collapse id=section-5f2cae171c6192fa410df4385f7218aa><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/prologue/introduction/>Introduction</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/prologue/faq/>FAQ</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-2ba0c1d2f0f117d4512ef6170fe0e015 aria-expanded=true>
Methodology</button><div class="collapse show" id=section-2ba0c1d2f0f117d4512ef6170fe0e015><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/methods/virtual-environment/>Virtual Environment</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/methods/protocol-specification/>Protocol Specification</a></li><li><a class="docs-link rounded active" href=https://pkel.github.io/cpr/docs/methods/simulator/>Simulator</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-9985b4390c40137573e6da05caf85874 aria-expanded=false>
Protocols</button><div class=collapse id=section-9985b4390c40137573e6da05caf85874><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/overview/>Overview</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/nakamoto/>Nakamoto</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/parallel-simple/>Parallel PoW (simplified)</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/parallel-aft22/>Parallel PoW (AFTâ€‰'22)</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/parallel-tree/>Tree-Structured Voting</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/tailstorm/>Tailstorm</a></li></ul></div></li></ul></nav></div><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=d-xl-none><button class="btn btn-outline-primary btn-sm doks-toc-toggle collapsed" type=button data-bs-toggle=collapse data-bs-target=#onThisPage aria-controls=doks-docs-nav aria-expanded=false aria-label="Toggle On this page navigation">
<span>On this page</span>
<span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-expand" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Expand</title><polyline points="7 13 12 18 17 13"/><polyline points="7 6 12 11 17 6"/></svg><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-collapse" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Collapse</title><polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/></svg></span></button><div class=collapse id=onThisPage><div class="card card-body mt-3 py-1"><div class=page-links><nav id=TableOfContents><ul><li><a href=#inputs>Inputs</a></li><li><a href=#concurrent-programming>Concurrent Programming</a></li><li><a href=#block-dag-and-visibility>Block DAG and Visibility</a></li><li><a href=#initialization>Initialization</a></li><li><a href=#proof-of-work>Proof-of-Work</a></li><li><a href=#block-delivery>Block Delivery</a></li><li><a href=#communication>Communication</a></li><li><a href=#non-pow-blocks>Non-PoW Blocks</a></li><li><a href=#discrete-event-simulation>Discrete Event Simulation</a></li></ul></nav></div></div></div></div><div class="page-links d-none d-xl-block"><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#inputs>Inputs</a></li><li><a href=#concurrent-programming>Concurrent Programming</a></li><li><a href=#block-dag-and-visibility>Block DAG and Visibility</a></li><li><a href=#initialization>Initialization</a></li><li><a href=#proof-of-work>Proof-of-Work</a></li><li><a href=#block-delivery>Block Delivery</a></li><li><a href=#communication>Communication</a></li><li><a href=#non-pow-blocks>Non-PoW Blocks</a></li><li><a href=#discrete-event-simulation>Discrete Event Simulation</a></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9"><h1>Simulator</h1><p class=lead>How we simulate protocol executions.</p><nav class=d-xl-none aria-label="Quaternary navigation"><div class=d-xl-none><button class="btn btn-outline-primary btn-sm doks-toc-toggle collapsed" type=button data-bs-toggle=collapse data-bs-target=#onThisPage aria-controls=doks-docs-nav aria-expanded=false aria-label="Toggle On this page navigation">
<span>On this page</span>
<span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-expand" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Expand</title><polyline points="7 13 12 18 17 13"/><polyline points="7 6 12 11 17 6"/></svg><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-collapse" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Collapse</title><polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/></svg></span></button><div class=collapse id=onThisPage><div class="card card-body mt-3 py-1"><div class=page-links><nav id=TableOfContents><ul><li><a href=#inputs>Inputs</a></li><li><a href=#concurrent-programming>Concurrent Programming</a></li><li><a href=#block-dag-and-visibility>Block DAG and Visibility</a></li><li><a href=#initialization>Initialization</a></li><li><a href=#proof-of-work>Proof-of-Work</a></li><li><a href=#block-delivery>Block Delivery</a></li><li><a href=#communication>Communication</a></li><li><a href=#non-pow-blocks>Non-PoW Blocks</a></li><li><a href=#discrete-event-simulation>Discrete Event Simulation</a></li></ul></nav></div></div></div></div><div class="page-links d-none d-xl-block"><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#inputs>Inputs</a></li><li><a href=#concurrent-programming>Concurrent Programming</a></li><li><a href=#block-dag-and-visibility>Block DAG and Visibility</a></li><li><a href=#initialization>Initialization</a></li><li><a href=#proof-of-work>Proof-of-Work</a></li><li><a href=#block-delivery>Block Delivery</a></li><li><a href=#communication>Communication</a></li><li><a href=#non-pow-blocks>Non-PoW Blocks</a></li><li><a href=#discrete-event-simulation>Discrete Event Simulation</a></li></ul></nav></div></nav><p>Having talked about our <a href=../virtual-environment>model for virtual protocol
executions</a> and about <a href=../protocol-specification>how we specify
protocols</a>, we can proceed with the
description of the network simulator. Like before, we use Python as
pseudocode to describe important details. The code snippets are
optimized for readability not speed. The real simulator is implemented
in a compiled language to achieve good performance.</p><h2 id=inputs>Inputs <a href=#inputs class=anchor aria-hidden=true>#</a></h2><p>The simulator takes as input the following assumptions about the network
and participating nodes.</p><p><code>n: int</code> defines the number of nodes, <code>range(n)</code> addresses the
individual nodes.</p><p><code>neighbours(i: int) -> int list</code> defines the outgoing network
connections of each node. If node <code>42</code> decides to share a block, the
simulator will send this block to the nodes returned by
<code>neighbours(42)</code>.</p><p><code>message_delay(src: int, dst: int) -> float</code> defines the message
propagation delays. If node <code>42</code> sends a block to node <code>7</code> at time <code>t</code>,
the simulator will deliver the block to node <code>7</code> at time <code>t + message_delay(42, 7)</code>. The function does not have to be
deterministic; it can model probability distributions. If the function
returns <code>float('inf')</code> the message will not be delivered.</p><p><code>roots</code> and <code>validity</code> define the structure of the blockchain as
discussed in <a href=../protocol-specification>the section on protocol
specifications</a>. The simulator rejects
invalid blocks.</p><p><code>node(i: int) -> tuple[init, update, mining]</code> defines the behaviour of nodes
as discussed in the <a href=../protocol-specification>the section on protocol
specifications</a>. In the simplest case, when
all nodes are honest, <code>node(i)</code> for all <code>i</code> returns the three functions
<code>init</code>, <code>update</code>, and <code>mining</code> as defined in the protocol specification.
In attack scenarios, <code>node(i)</code> returns nonconforming functions for the
malicious nodes.</p><p><code>mining_delay() -> float</code> and <code>select_miner() -> int</code> model
proof-of-work difficulty and hash-rates of the nodes. <code>mining_delay()</code>
defines the time between consecutive mining events. It is typically a
random function returning independent and exponentially distributed
values. <code>select_miner()</code> defines which node is successful at a
particular mining event. It is typically a random function which selects
nodes based on their relative hash-rate.</p><figure style=width:100%><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>nakamoto</span>  <span class=c1># protocol specification</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>numpy</span> <span class=kn>import</span> <span class=n>random</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mining_delay</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>random</span><span class=o>.</span><span class=n>exponential</span><span class=p>(</span><span class=n>scale</span><span class=o>=</span><span class=mi>600</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>select_miner</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>hash_rates</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>n</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>),</span> <span class=n>p</span><span class=o>=</span><span class=n>hash_rates</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>neighbours</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>x</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=k>if</span> <span class=n>x</span> <span class=o>!=</span> <span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>message_delay</span><span class=p>(</span><span class=n>src</span><span class=p>,</span> <span class=n>dst</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>roots</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>nakamoto</span><span class=o>.</span><span class=n>roots</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>validity</span><span class=p>(</span><span class=n>block</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>nakamoto</span><span class=o>.</span><span class=n>validity</span><span class=p>(</span><span class=n>block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>node</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>nakamoto</span><span class=o>.</span><span class=n>init</span><span class=p>,</span> <span class=n>nakamoto</span><span class=o>.</span><span class=n>update</span><span class=p>,</span> <span class=n>nakamoto</span><span class=o>.</span><span class=n>mining</span><span class=p>)</span>
</span></span></code></pre></div><figcaption>Example network with <code>n = 7</code> nodes following the <a href=/cpr/docs/protocols/nakamoto/>Nakamoto
consensus</a> protocol. All messages are
delayed for 6 seconds. The block interval will be about 10 minutes.
Hash-rates are chosen arbitrarily.</figcaption></figure><h2 id=concurrent-programming>Concurrent Programming <a href=#concurrent-programming class=anchor aria-hidden=true>#</a></h2><p>We describe the simulator as a concurrent program.
The program does not use parallelism&mdash;all computations happen
sequentially in a single thread.
We introduce two primitives to delay function evaluation.</p><ul><li><code>delay(n, fun, *args)</code> schedules the evaluation of <code>fun(*args)</code> in <code>n</code>
seconds. While waiting, other computations may happen concurrently.</li><li><code>delay_until(prop, fun, *args)</code> schedules the evaluation of
<code>fun(*args)</code> as soon as <code>prop()</code> returns <code>True</code>. While <code>prop()</code> returns
<code>False</code> other computations may take place concurrently.</li></ul><p>Consider the following example program which prints the letters <em>a</em> to
<em>f</em> in order. We invite the curious reader to take a look at the
<a href=../concurrent_programming_asyncio.py>complete program</a>, including
an implementation of the two primitives <code>delay</code> and <code>delay_until</code> using
Python&rsquo;s <code>asyncio</code>.</p><figure style=width:100%><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>f</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>.</span><span class=n>count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>f</span><span class=o>.</span><span class=n>start</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;at second </span><span class=si>{</span><span class=n>t</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>f</span><span class=o>.</span><span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>f</span><span class=o>.</span><span class=n>count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>f</span><span class=p>(</span><span class=s2>&#34;a&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delay</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=s2>&#34;d&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delay</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=s2>&#34;c&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>delay</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=s2>&#34;f&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delay_until</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=n>f</span><span class=o>.</span><span class=n>count</span> <span class=o>&gt;=</span> <span class=mi>4</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=s2>&#34;e&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>f</span><span class=p>(</span><span class=s2>&#34;b&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## expected output:</span>
</span></span><span class=line><span class=cl><span class=c1># at second 0: a</span>
</span></span><span class=line><span class=cl><span class=c1># at second 0: b</span>
</span></span><span class=line><span class=cl><span class=c1># at second 0: c</span>
</span></span><span class=line><span class=cl><span class=c1># at second 2: d</span>
</span></span><span class=line><span class=cl><span class=c1># at second 2: e</span>
</span></span><span class=line><span class=cl><span class=c1># at second 3: f</span>
</span></span></code></pre></div><figcaption>Example program demonstrating the two scheduling primitives <code>delay</code> and
<code>delay_until</code>.</figcaption></figure><h2 id=block-dag-and-visibility>Block DAG and Visibility <a href=#block-dag-and-visibility class=anchor aria-hidden=true>#</a></h2><p>As <a href=/cpr/docs/methods/virtual-environment/>discussed before</a> the
simulator will maintain a DAG of all blocks mined or appended by any
nodes. Individual nodes however have only a partial view on this DAG. In
our program, we set local views as follows.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>dag</span> <span class=o>=</span> <span class=n>DAG</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=c1># in this context dag represents the global view on _all_ blocks</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>dag</span><span class=o>.</span><span class=n>set_view</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1># in this context visibility of parents and children is restricted</span>
</span></span><span class=line><span class=cl>    <span class=c1># according to the local view of node i</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=c1># in this context dag represents the global view on _all_ blocks</span>
</span></span></code></pre></div><p>Local views are read-only. The node functions <code>init</code>, <code>mining</code>, and
<code>update</code> cannot append blocks to the DAG. Instead, they return requests
for appending a block to the simulator. We will describe below, how the
simulator handles these requests.</p><p>The local view makes the nodes&rsquo; id accessible to the node by setting
<code>my_id = i</code> within the context.</p><h2 id=initialization>Initialization <a href=#initialization class=anchor aria-hidden=true>#</a></h2><p>We start each simulation with the initialization of the block DAG,
the protocol&rsquo;s <code>root</code> blocks, and the nodes&rsquo; state.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># initialize empty block DAG</span>
</span></span><span class=line><span class=cl><span class=n>dag</span> <span class=o>=</span> <span class=n>DAG</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># obtain drafts for the protocol&#39;s root blocks, convert them into</span>
</span></span><span class=line><span class=cl><span class=c1># actual blocks, and make them visible to all nodes.</span>
</span></span><span class=line><span class=cl><span class=n>root_blocks</span> <span class=o>=</span> <span class=p>[</span><span class=n>dag</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>b</span><span class=p>)</span> <span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=n>roots</span><span class=p>()]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=n>root_blocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>dag</span><span class=o>.</span><span class=n>make_visible</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># nodes&#39; state</span>
</span></span><span class=line><span class=cl><span class=n>state</span> <span class=o>=</span> <span class=p>[</span><span class=kc>None</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>init</span><span class=p>,</span> <span class=n>_update</span><span class=p>,</span> <span class=n>_mining</span> <span class=o>=</span> <span class=n>node</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>dag</span><span class=o>.</span><span class=n>set_view</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>state</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>init</span><span class=p>(</span><span class=n>blocks</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=proof-of-work>Proof-of-Work <a href=#proof-of-work class=anchor aria-hidden=true>#</a></h2><p>After initialization, the simulator starts a concurrent loop which
models proof-of-work and mining. The loop repeatedly samples and waits
for a mining delay, selects a random node as successful miner, obtains a
block draft from this miner, converts the draft into a block, checks
block validity, and informs the miner about the freshly mined block.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>proof_of_work</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># select random miner</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=n>select_miner</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># obtain block draft from miner</span>
</span></span><span class=line><span class=cl>    <span class=n>_init</span><span class=p>,</span> <span class=n>_update</span><span class=p>,</span> <span class=n>mining</span> <span class=o>=</span> <span class=n>node</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>dag</span><span class=o>.</span><span class=n>set_view</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>draft</span> <span class=o>=</span> <span class=n>mining</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># convert draft to block w/ proof-of-work</span>
</span></span><span class=line><span class=cl>    <span class=n>block</span> <span class=o>=</span> <span class=n>dag</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>draft</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>block</span><span class=o>.</span><span class=n>has_pow</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=c1># enforce validity of all appended blocks</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>validity</span><span class=p>(</span><span class=n>block</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># inform miner about freshly mined block</span>
</span></span><span class=line><span class=cl>        <span class=n>deliver</span><span class=p>(</span><span class=n>block</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=s2>&#34;proof-of-work&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>dag</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># continue proof-of-work loop after random delay</span>
</span></span><span class=line><span class=cl>    <span class=n>delay</span><span class=p>(</span><span class=n>mining_delay</span><span class=p>(),</span> <span class=n>proof_of_work</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># enter proof-of-work loop</span>
</span></span><span class=line><span class=cl><span class=n>delay</span><span class=p>(</span><span class=n>mining_delay</span><span class=p>(),</span> <span class=n>proof_of_work</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=block-delivery>Block Delivery <a href=#block-delivery class=anchor aria-hidden=true>#</a></h2><p>Block delivery is what we call informing a node about a new block.
From the perspective of a node, new blocks might be freshly mined
locally, just appended locally, or received from the network.</p><p>We handle these deliveries in the <code>deliver</code> function. The function makes
the block visible to the node, applies the node&rsquo;s <code>update</code> function, and
handles the returned instructions to share existing or append new
blocks.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>deliver</span><span class=p>(</span><span class=n>block</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># update local visibility</span>
</span></span><span class=line><span class=cl>    <span class=n>dag</span><span class=o>.</span><span class=n>make_visible</span><span class=p>(</span><span class=n>block</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># simulate node i&#39;s action</span>
</span></span><span class=line><span class=cl>    <span class=n>_init</span><span class=p>,</span> <span class=n>update</span><span class=p>,</span> <span class=n>_mining</span> <span class=o>=</span> <span class=n>node</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>dag</span><span class=o>.</span><span class=n>set_view</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=n>update</span><span class=p>(</span><span class=n>state</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>block</span><span class=p>,</span> <span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># store updated state</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>ret</span><span class=o>.</span><span class=n>state</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># handle communication</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>msg</span> <span class=ow>in</span> <span class=n>ret</span><span class=o>.</span><span class=n>share</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>broadcast</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># handle appends w/o proof-of-work</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>draft</span> <span class=ow>in</span> <span class=n>ret</span><span class=o>.</span><span class=n>append</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>append</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>draft</span><span class=p>)</span>
</span></span></code></pre></div><p>The <a href=/cpr/docs/methods/protocol-specification/>protocol specification</a>
assumes that blocks are delivered in order, that is, that the parents of
a delivered block have been delivered before. For our previous use of
<code>deliver</code> in the proof-of-work loop, this invariant is trivially true.
The following wrapper ensures in-order delivery for messages received
from the network.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>deliver_in_order</span><span class=p>(</span><span class=n>block</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>deliver_once</span><span class=p>(</span><span class=n>block</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>dag</span><span class=o>.</span><span class=n>is_visible</span><span class=p>(</span><span class=n>block</span><span class=p>,</span> <span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>deliver</span><span class=p>(</span><span class=n>block</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>all_parents_visible</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>parent</span> <span class=ow>in</span> <span class=n>block</span><span class=o>.</span><span class=n>parents</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>dag</span><span class=o>.</span><span class=n>is_visible</span><span class=p>(</span><span class=n>parent</span><span class=p>,</span> <span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>delay_until</span><span class=p>(</span><span class=n>parents_visible</span><span class=p>,</span> <span class=n>deliver_once</span><span class=p>,</span> <span class=n>block</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>event</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=communication>Communication <a href=#communication class=anchor aria-hidden=true>#</a></h2><p>Nodes may request block broadcasts from their <code>update</code> function. The
simulator&rsquo;s <a href=#block-delivery><code>delivery</code></a> function forwards these
requests to the <code>broadcast</code> function below. For each of the sending
node&rsquo;s (<code>src</code>) neighbors, this function samples a message delay (<code>t</code>)
and&mdash;after waiting for delay&mdash;delivers the block to the receiver
(<code>dst</code>).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>broadcast</span><span class=p>(</span><span class=n>src</span><span class=p>,</span> <span class=n>block</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>dst</span> <span class=ow>in</span> <span class=n>neighbours</span><span class=p>(</span><span class=n>src</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span> <span class=o>=</span> <span class=n>message_delay</span><span class=p>(</span><span class=n>src</span><span class=p>,</span> <span class=n>dst</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>delay</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>deliver_in_order</span><span class=p>,</span> <span class=n>dst</span><span class=p>,</span> <span class=n>block</span><span class=p>,</span> <span class=s2>&#34;network&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=non-pow-blocks>Non-PoW Blocks <a href=#non-pow-blocks class=anchor aria-hidden=true>#</a></h2><p>Nodes may request block appends from their <code>update</code> function. The
simulator&rsquo;s <a href=#block-delivery><code>delivery</code></a> function forwards these
requests to the <code>append</code> function below. Without delay, the function
appends the block draft to the DAG, ensures validity, and delivers the
new block to the requesting node. Block&rsquo;s originating from this
mechanism do not carry a proof-of-work.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>append</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>draft</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>block</span> <span class=o>=</span> <span class=n>dag</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>draft</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>block</span><span class=o>.</span><span class=n>pow</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>validity</span><span class=p>(</span><span class=n>block</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>deliver</span><span class=p>(</span><span class=n>block</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=s2>&#34;append&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>dag</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>block</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=discrete-event-simulation>Discrete Event Simulation <a href=#discrete-event-simulation class=anchor aria-hidden=true>#</a></h2><p><a href=#concurrent-programming>Above</a> we suggest to use concurrent
programming to implement the scheduling primitives <code>delay</code> and
<code>delay_until</code>. If implemented naively, the simulator would spend most
the time waiting for the delays or checking properties becoming true.
A delay of <code>n</code> seconds would actually take <code>n</code> seconds to
simulate. Simulations would be real-time, but real-time is
inconveniently slow in the proof-of-work blockchain context.</p><p>We speed up the simulation by skipping the delayed time instead of
waiting for it to pass. The approach is called <a href=https://en.wikipedia.org/wiki/Discrete-event_simulation>discrete-event
simulation</a>.
The trick is to maintain a time-ordered queue of future events and
define a loop that handles the scheduled events one after another until
none are left. In the context of this simulator, future events are
delayed function calls. Handling an event is as simple as evaluating the
call. Each call may schedule further delayed calls. The time-ordering of
the queue ensures that the calls happen in the same order as they would
with naive waiting.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>queue</span> <span class=kn>import</span> <span class=n>PriorityQueue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>time</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>queue</span> <span class=o>=</span> <span class=n>PriorityQueue</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>props</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delay</span><span class=p>(</span><span class=n>seconds</span><span class=p>,</span> <span class=n>fun</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>queue</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>time</span> <span class=o>+</span> <span class=n>seconds</span><span class=p>,</span> <span class=n>fun</span><span class=p>,</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delay_until</span><span class=p>(</span><span class=n>prop</span><span class=p>,</span> <span class=n>fun</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>prop</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>prop</span><span class=p>,</span> <span class=n>fun</span><span class=p>,</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># simulator code goes here</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=ow>not</span> <span class=n>queue</span><span class=o>.</span><span class=n>empty</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># dequeue and handle next event</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=p>,</span> <span class=n>fun</span><span class=p>,</span> <span class=n>args</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>fun</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># re-evaluate delay_until properties</span>
</span></span><span class=line><span class=cl>    <span class=n>next_props</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>prop</span><span class=p>,</span> <span class=n>fun</span><span class=p>,</span> <span class=n>args</span> <span class=ow>in</span> <span class=n>props</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>prop</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>fun</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>next_props</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>prop</span><span class=p>,</span> <span class=n>fun</span><span class=p>,</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>props</span> <span class=o>=</span> <span class=n>next_props</span>
</span></span></code></pre></div><p>Note that using <code>delay_until</code> can cause significant overhead. We
introduced this scheduling primitive to improve readability of the
simulator pseudo-code. We completely avoid this kind of scheduling in
our optimized simulator implementation.</p><div class="page-footer-meta d-flex flex-column flex-md-row justify-content-between"><div class=last-modified><a href=https://github.com/pkel/cpr/commit/da1d8904827ad7faeffa5ed08053ac94e12a98ac><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Last modified on November 15, 2023</a></div><div class=edit-page><a href=https://github.com/pkel/cpr/blob/website/website/content/en/docs/methods/simulator.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></div></div><div class="docs-navigation d-flex justify-content-between"><a href=/cpr/docs/methods/protocol-specification/><div class="card my-1"><div class="card-body py-2">&larr; Protocol Specification</div></div></a><a class=ms-auto href=/cpr/docs/protocols/overview/><div class="card my-1"><div class="card-body py-2">Overview &rarr;</div></div></a></div></main></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a class=text-muted href=https://gohugo.io/>Hugo</a> and <a class=text-muted href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=/cpr/js/bootstrap.min.87685cf4e6585276ff9e7b5d0b97e792615af6921e77821315d1ca7c5511ac2f30667e16c0d031e680ca8b57f63f6c0f6c4a232da777cce474b501ed81e090a9.js integrity="sha512-h2hc9OZYUnb/nntdC5fnkmFa9pIed4ITFdHKfFURrC8wZn4WwNAx5oDKi1f2P2wPbEojLad3zOR0tQHtgeCQqQ==" crossorigin=anonymous defer></script>
<script src=/cpr/js/highlight.min.56a414730f1135fe77b5ea30bf74a2cc4101a6f386e85e5b789c800570cc33d33054000f45932c053a59b41018f72687867254a80e1b9710671852492533162f.js integrity="sha512-VqQUcw8RNf53teowv3SizEEBpvOG6F5beJyABXDMM9MwVAAPRZMsBTpZtBAY9yaHhnJUqA4blxBnGFJJJTMWLw==" crossorigin=anonymous defer></script>
<script src=/cpr/js/vendor/katex/dist/katex.min.ed3f25b49c13f756d6454d3bfdc2090afae6101a06312e6bd27f154380b31c955bb4615215ef7518b270b4f9013bc757ffa2587509afd55cbf98bdd4e06064b3.js integrity="sha512-7T8ltJwT91bWRU07/cIJCvrmEBoGMS5r0n8VQ4CzHJVbtGFSFe91GLJwtPkBO8dX/6JYdQmv1Vy/mL3U4GBksw==" crossorigin=anonymous defer></script>
<script src=/cpr/js/vendor/katex/dist/contrib/auto-render.min.f128dc24877a8ff5cdc694570f6cd25f8ad512d4330c242487c4cbbc5dc6fd2c52de778da1e59f98585d1defd5aa5aa583da59e90e6837973ecca3b45b01fb64.js integrity="sha512-8SjcJId6j/XNxpRXD2zSX4rVEtQzDCQkh8TLvF3G/SxS3neNoeWfmFhdHe/Vqlqlg9pZ6Q5oN5c+zKO0WwH7ZA==" crossorigin=anonymous defer></script>
<script src=/cpr/main.min.dcd3405902a4381167a9b62eb3f84939ffa863717d14f9ad3d6ac60715885caacc14864978ab396dca37cd3c69d903d955c44c33896c13f3ff6f7609fb10215f.js integrity="sha512-3NNAWQKkOBFnqbYus/hJOf+oY3F9FPmtPWrGBxWIXKrMFIZJeKs5bco3zTxp2QPZVcRMM4lsE/P/b3YJ+xAhXw==" crossorigin=anonymous defer></script>
<script src=https://pkel.github.io/cpr/index.min.1e732a0d585e95b6a5516fc67b130f991ae0a19db71c9d132fbc6a2b209eeeaad2a6f1d879d464d09fc22b9ea9ae7d1d6fb0146a31e0954dd13b243b31c5ba20.js integrity="sha512-HnMqDVhelbalUW/GexMPmRrgoZ23HJ0TL7xqKyCe7qrSpvHYedRk0J/CK56prn0db7AUajHglU3ROyQ7McW6IA==" crossorigin=anonymous defer></script></body></html>