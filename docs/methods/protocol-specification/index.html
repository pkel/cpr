<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://pkel.github.io/cpr/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://pkel.github.io/cpr/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://pkel.github.io/cpr/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://pkel.github.io/cpr/fonts/KaTeX_Main-Regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://pkel.github.io/cpr/fonts/KaTeX_Math-Italic.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=https://pkel.github.io/cpr/main.6e037184ad2fffb3cb08d2d2b77a9bc14a94a0b2928bf6322547eff1b32067172eb1864ac39b8b3387219794c38e8ed2072e7e76f957d321ccf5a606383583e5.css integrity="sha512-bgNxhK0v/7PLCNLSt3qbwUqUoLKSi/YyJUfv8bMgZxcusYZKw5uLM4chl5TDjo7SBy5+dvlX0yHM9aYGODWD5Q==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Protocol Specification - CPR</title><meta name=description content="How to read protocol specifications.
"><link rel=canonical href=https://pkel.github.io/cpr/docs/methods/protocol-specification/><meta property="og:locale" content><meta property="og:type" content="article"><meta property="og:title" content="Protocol Specification"><meta property="og:description" content="How to read protocol specifications.
"><meta property="og:url" content="https://pkel.github.io/cpr/docs/methods/protocol-specification/"><meta property="og:site_name" content="CPR"><meta property="article:modified_time" content="2022-12-22T12:24:21+01:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content><meta name=twitter:creator content><meta name=twitter:title content="Protocol Specification"><meta name=twitter:description content="How to read protocol specifications.
"><meta name=twitter:card content="summary"><meta name=twitter:image:alt content="Protocol Specification"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://pkel.github.io/#/schema/person/1","name":"CPR","url":"https://pkel.github.io/","sameAs":["https://github.com/pkel/cpr"],"image":{"@type":"ImageObject","@id":"https://pkel.github.io/#/schema/image/1","url":"https://pkel.github.io/\u003cnil\u003e","width":null,"height":null,"caption":"CPR"}},{"@type":"WebSite","@id":"https://pkel.github.io/#/schema/website/1","url":"https://pkel.github.io/","name":"CPR","description":"CPR provides tools for specifying, simulating, and attacking proof-of-work consensus protocols like Bitcoin and Ethereum.","publisher":{"@id":"https://pkel.github.io/#/schema/person/1"}},{"@type":"WebPage","@id":"https://pkel.github.io/cpr/docs/methods/protocol-specification/","url":"https://pkel.github.io/cpr/docs/methods/protocol-specification/","name":"Protocol Specification","description":"How to read protocol specifications.\n","isPartOf":{"@id":"https://pkel.github.io/#/schema/website/1"},"about":{"@id":"https://pkel.github.io/#/schema/person/1"},"datePublished":"0001-01-01T00:00:00CET","dateModified":"2022-12-22T12:24:21CET","breadcrumb":{"@id":"https://pkel.github.io/cpr/docs/methods/protocol-specification/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://pkel.github.io/cpr/docs/methods/protocol-specification/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://pkel.github.io/cpr/docs/methods/protocol-specification/"]}]},{"@type":"BreadcrumbList","@id":"https://pkel.github.io/cpr/docs/methods/protocol-specification/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://pkel.github.io/cpr/","url":"https://pkel.github.io/cpr/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://pkel.github.io/cpr/docs/","url":"https://pkel.github.io/cpr/docs/","name":"Docs"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://pkel.github.io/cpr/docs/methods/","url":"https://pkel.github.io/cpr/docs/methods/","name":"Methods"}},{"@type":"ListItem","position":4,"item":{"@id":"https://pkel.github.io/cpr/docs/methods/protocol-specification/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://pkel.github.io/#/schema/article/1","headline":"Protocol Specification","description":"How to read protocol specifications.\n","isPartOf":{"@id":"https://pkel.github.io/cpr/docs/methods/protocol-specification/"},"mainEntityOfPage":{"@id":"https://pkel.github.io/cpr/docs/methods/protocol-specification/"},"datePublished":"0001-01-01T00:00:00CET","dateModified":"2022-12-22T12:24:21CET","author":{"@id":"https://pkel.github.io/#/schema/person/2"},"publisher":{"@id":"https://pkel.github.io/#/schema/person/1"},"image":{"@id":"https://pkel.github.io/cpr/docs/methods/protocol-specification/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://pkel.github.io/#/schema/person/2","name":"Patrik Keller","sameAs":["https://github.com/pkel"]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://pkel.github.io/cpr/docs/methods/protocol-specification/#/schema/image/2","url":null,"contentUrl":null,"caption":"Protocol Specification"}]}]}</script><meta name=theme-color content="#fff"><link rel=icon href=https://pkel.github.io/cpr/favicon.ico sizes=any><link rel=apple-touch-icon sizes=180x180 href=https://pkel.github.io/cpr/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://pkel.github.io/cpr/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://pkel.github.io/cpr/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://pkel.github.io/cpr/site.webmanifest></head><body class="docs single"><div class=sticky-top><div class=header-bar></div><header class="navbar navbar-expand-lg navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/ aria-label=CPR>CPR</a>
<button class="btn btn-link order-0 ms-auto d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasExample aria-controls=offcanvasExample><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-horizontal"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg></button><div class="offcanvas offcanvas-start d-lg-none" tabindex=-1 id=offcanvasExample aria-labelledby=offcanvasExampleLabel><div class=header-bar></div><div class=offcanvas-header><h5 class=offcanvas-title id=offcanvasExampleLabel>Browse docs</h5><button type=button class=btn-close data-bs-dismiss=offcanvas aria-label=Close></button></div><div class=offcanvas-body><aside class="doks-sidebar mt-n3"><nav id=doks-docs-nav aria-label="Tertiary navigation"><ul class="list-unstyled collapsible-sidebar"><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-5f2cae171c6192fa410df4385f7218aa aria-expanded=false>
Prologue</button><div class=collapse id=section-5f2cae171c6192fa410df4385f7218aa><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/prologue/introduction/>Introduction</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/prologue/faq/>FAQ</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-2ba0c1d2f0f117d4512ef6170fe0e015 aria-expanded=true>
Methodology</button><div class="collapse show" id=section-2ba0c1d2f0f117d4512ef6170fe0e015><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/methods/virtual-environment/>Virtual Environment</a></li><li><a class="docs-link rounded active" href=https://pkel.github.io/cpr/docs/methods/protocol-specification/>Protocol Specification</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/methods/simulator/>Simulator</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-9985b4390c40137573e6da05caf85874 aria-expanded=false>
Protocols</button><div class=collapse id=section-9985b4390c40137573e6da05caf85874><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/overview/>Overview</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/nakamoto/>Nakamoto</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/parallel-simple/>Parallel PoW (simplified)</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/parallel-aft22/>Parallel PoW (AFTâ€‰'22)</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/parallel-tree/>Tree-Structured Voting</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/tailstorm/>Tailstorm</a></li></ul></div></li></ul></nav></aside></div></div><button class="btn btn-menu order-2 d-block d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-lg-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-lg-none"></div><div class="offcanvas-header d-lg-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/>CPR</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body p-4 p-lg-0"><ul class="nav flex-column flex-lg-row align-items-lg-center mt-2 mt-lg-0 ms-lg-2 me-lg-auto"><li class=nav-item><a class="nav-link ps-0 py-1 active" href=/cpr/docs/prologue/introduction/>Docs</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/cpr/blog/>Blog</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><form class="doks-search position-relative flex-grow-1 ms-lg-auto me-lg-2"><input id=search class="form-control is-search" type=search placeholder="Search docs..." aria-label="Search docs..." autocomplete=off><div id=suggestions class="shadow bg-white rounded d-none"></div></form><hr class="text-black-50 my-4 d-lg-none"><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=https://github.com/pkel/cpr><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-lg-none">GitHub</small></a></li></ul></div></div></nav></header></div><div class=container-xxl><aside class=doks-sidebar><nav id=doks-docs-nav class="collapse d-lg-none" aria-label="Tertiary navigation"><ul class="list-unstyled collapsible-sidebar"><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-5f2cae171c6192fa410df4385f7218aa aria-expanded=false>
Prologue</button><div class=collapse id=section-5f2cae171c6192fa410df4385f7218aa><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/prologue/introduction/>Introduction</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/prologue/faq/>FAQ</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-2ba0c1d2f0f117d4512ef6170fe0e015 aria-expanded=true>
Methodology</button><div class="collapse show" id=section-2ba0c1d2f0f117d4512ef6170fe0e015><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/methods/virtual-environment/>Virtual Environment</a></li><li><a class="docs-link rounded active" href=https://pkel.github.io/cpr/docs/methods/protocol-specification/>Protocol Specification</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/methods/simulator/>Simulator</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-9985b4390c40137573e6da05caf85874 aria-expanded=false>
Protocols</button><div class=collapse id=section-9985b4390c40137573e6da05caf85874><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/overview/>Overview</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/nakamoto/>Nakamoto</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/parallel-simple/>Parallel PoW (simplified)</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/parallel-aft22/>Parallel PoW (AFTâ€‰'22)</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/parallel-tree/>Tree-Structured Voting</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/tailstorm/>Tailstorm</a></li></ul></div></li></ul></nav></aside></div><div class="wrap container-xxl" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar d-none d-lg-block"><nav class=docs-links aria-label="Main navigation"><ul class="list-unstyled collapsible-sidebar"><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-5f2cae171c6192fa410df4385f7218aa aria-expanded=false>
Prologue</button><div class=collapse id=section-5f2cae171c6192fa410df4385f7218aa><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/prologue/introduction/>Introduction</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/prologue/faq/>FAQ</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-2ba0c1d2f0f117d4512ef6170fe0e015 aria-expanded=true>
Methodology</button><div class="collapse show" id=section-2ba0c1d2f0f117d4512ef6170fe0e015><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/methods/virtual-environment/>Virtual Environment</a></li><li><a class="docs-link rounded active" href=https://pkel.github.io/cpr/docs/methods/protocol-specification/>Protocol Specification</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/methods/simulator/>Simulator</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-9985b4390c40137573e6da05caf85874 aria-expanded=false>
Protocols</button><div class=collapse id=section-9985b4390c40137573e6da05caf85874><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/overview/>Overview</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/nakamoto/>Nakamoto</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/parallel-simple/>Parallel PoW (simplified)</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/parallel-aft22/>Parallel PoW (AFTâ€‰'22)</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/parallel-tree/>Tree-Structured Voting</a></li><li><a class="docs-link rounded" href=https://pkel.github.io/cpr/docs/protocols/tailstorm/>Tailstorm</a></li></ul></div></li></ul></nav></div><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=d-xl-none><button class="btn btn-outline-primary btn-sm doks-toc-toggle collapsed" type=button data-bs-toggle=collapse data-bs-target=#onThisPage aria-controls=doks-docs-nav aria-expanded=false aria-label="Toggle On this page navigation">
<span>On this page</span>
<span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-expand" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Expand</title><polyline points="7 13 12 18 17 13"/><polyline points="7 6 12 11 17 6"/></svg><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-collapse" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Collapse</title><polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/></svg></span></button><div class=collapse id=onThisPage><div class="card card-body mt-3 py-1"><div class=page-links><nav id=TableOfContents><ul><li><a href=#blockchain>Blockchain</a></li><li><a href=#node>Node</a></li><li><a href=#difficulty-adjustment>Difficulty Adjustment</a></li><li><a href=#rewards>Rewards</a></li></ul></nav></div></div></div></div><div class="page-links d-none d-xl-block"><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#blockchain>Blockchain</a></li><li><a href=#node>Node</a></li><li><a href=#difficulty-adjustment>Difficulty Adjustment</a></li><li><a href=#rewards>Rewards</a></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9"><h1>Protocol Specification</h1><p class=lead>How to read protocol specifications.</p><nav class=d-xl-none aria-label="Quaternary navigation"><div class=d-xl-none><button class="btn btn-outline-primary btn-sm doks-toc-toggle collapsed" type=button data-bs-toggle=collapse data-bs-target=#onThisPage aria-controls=doks-docs-nav aria-expanded=false aria-label="Toggle On this page navigation">
<span>On this page</span>
<span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-expand" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Expand</title><polyline points="7 13 12 18 17 13"/><polyline points="7 6 12 11 17 6"/></svg><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-collapse" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Collapse</title><polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/></svg></span></button><div class=collapse id=onThisPage><div class="card card-body mt-3 py-1"><div class=page-links><nav id=TableOfContents><ul><li><a href=#blockchain>Blockchain</a></li><li><a href=#node>Node</a></li><li><a href=#difficulty-adjustment>Difficulty Adjustment</a></li><li><a href=#rewards>Rewards</a></li></ul></nav></div></div></div></div><div class="page-links d-none d-xl-block"><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#blockchain>Blockchain</a></li><li><a href=#node>Node</a></li><li><a href=#difficulty-adjustment>Difficulty Adjustment</a></li><li><a href=#rewards>Rewards</a></li></ul></nav></div></nav><p>Protocol designers write protocol specifications for consumption by
analysts and engineers. The engineer reads the specification and
implements it. The analysts reads the specification and tries to find
attacks or rule them out. Both analysts and engineers want to interpret
the specification as intended by the designer. Practically minded
attackers will attack an implementation, not the specification.</p><p>Depending on the context, we take the role of the designer or the
analysts. We never take the role of the engineer or the practically
minded attacker. When we discuss attacks, we generally assume that
engineers implement the protocol as specified.</p><p>We specify protocols in pseudo-code. That is, we write protocols as
programs but these programs are meant for human consumption. We prefer
readability over elegance and elegance over efficiency. We use Python&rsquo;s
syntax and core functionality hoping that this makes our protocol
specifications accessible to a wide audience.</p><p>A protocol specification consists of at least five functions: <code>roots</code>,
<code>validity</code>, <code>init</code>, <code>update</code> and <code>mining</code>. The first two, <code>roots</code> and
<code>validity</code> specify the structure of the protocol&rsquo;s blockchain. The other
three, <code>init</code>, <code>update</code> and <code>mining</code>, specify the node. (Go back to <a href=../virtual-environment>the
previous section</a> again, if you are confused by
the term <em>&#171;node&#187;</em>).</p><p>The protocol specification might list additional functions for internal
use by other functions or to specify difficulty adjustment and reward
schemes. For now, we will focus on the core functionality and the five
functions mentioned above.</p><h2 id=blockchain>Blockchain <a href=#blockchain class=anchor aria-hidden=true>#</a></h2><p>Protocols specify and use a global, append-only data-structure.
<a href=../virtual-environment#blobs-hashes-blockchain>A-priori, blocks form a directed acyclic graph
(DAG)</a>. Each block has
an arbitrary number of parent blocks and can store arbitrary data. The
<code>validity</code> function then restricts what blocks can be appended and
thereby imposes a certain structure on the DAG.</p><p>The <code>validity</code> function takes a block as argument. It may return <code>True</code>
or <code>False</code>, or it may fail. The specification consumer must ensure that
all appended blocks are valid, that is, <code>validity</code> returns <code>True</code>.</p><figure style=width:100%><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>validity</span><span class=p>(</span><span class=n>b</span><span class=p>:</span> <span class=n>Block</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>b</span><span class=o>.</span><span class=n>parents</span><span class=p>())</span> <span class=o>==</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>b</span><span class=o>.</span><span class=n>has_pow</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>b</span><span class=o>.</span><span class=n>height</span> <span class=o>==</span> <span class=n>b</span><span class=o>.</span><span class=n>parents</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>height</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>True</span>
</span></span></code></pre></div><figcaption>The <code>validity</code> function of <a href=/cpr/docs/protocols/nakamoto/>Nakamoto
consensus</a> specifies that each block has
exactly one parent, that each block has a proof-of-work, and that a
block&rsquo;s height is the parent&rsquo;s height plus one. The first rule restricts
the DAG to be a tree.</figcaption></figure><p>Protocol designers may specify an initial set of blocks which do not
have to be valid. This is done in the specification&rsquo;s <code>roots</code> function.
It takes no argument and returns a list of blocks. The specification
consumer must ensure that these blocks are part of the DAG when protocol
executions begins.</p><figure style=width:100%><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>roots</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>Block</span><span class=p>(</span><span class=n>height</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>miner</span><span class=o>=</span><span class=kc>None</span><span class=p>)]</span>
</span></span></code></pre></div><figcaption><a href=/cpr/docs/protocols/nakamoto/>Nakamoto consensus</a> has a single root
block, often called <em>&#171;genesis&#187;</em>. It does not have any parent blocks
and its height is zero.</figcaption></figure><h2 id=node>Node <a href=#node class=anchor aria-hidden=true>#</a></h2><p>The blockchain, as defined by <code>roots</code> and <code>validity</code>, is a global
data-structure. But nodes act on local knowledge. They might <a href=../virtual-environment#visibility-and-communication>see only a
subset</a> of the
blockchain depending on what information the other nodes share, when
they share it, and how messages propagate through the network.</p><p>Nodes are specified with three functions <code>init</code>, <code>update</code>, and <code>mining</code>.</p><p><code>init</code> takes a list of blocks as argument and returns the node&rsquo;s initial
state. The specification consumer must ensure that the list of blocks
given to <code>init</code> is the list of blocks defined by the global <code>roots</code>
function.</p><figure style=width:100%><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>init</span><span class=p>(</span><span class=n>roots</span><span class=p>:</span> <span class=p>[</span><span class=n>Block</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>roots</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span></code></pre></div><figcaption><a href=/cpr/docs/protocols/nakamoto/>Nakamoto consensus</a> nodes use as state
their preferred tip of the chain. Initially they prefer the genesis
block.</figcaption></figure><p><code>update</code> informs the node about new blocks. It takes as argument the
node&rsquo;s old state, the new block, and a string indicating how the new
block became visible locally. It returns a new state, a list of blocks
to share, and a list of blocks to append without proof-of-work. The
protocol designer must ensure that</p><ul><li><code>update</code> is called on all blocks as they become locally visible,</li><li>the new block given as argument and all its ancestors are locally visible,</li><li>the returned state will be given as first argument to the next update,</li><li>the to-be-shared blocks are validated and sent to the other nodes,</li><li>the to-be-appended blocks are validated, appended to the global block
DAG, and made visible locally,</li><li>the <code>event</code> argument is <code>"mining"</code> if the new block was mined
locally,</li><li>the <code>event</code> argument is <code>"append"</code> if the new block was appended locally
without proof-of-work, and</li><li>the <code>event</code> argument is <code>"network"</code> if the new block was received from the
network.</li></ul><figure style=width:100%><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>update</span><span class=p>(</span><span class=n>old</span><span class=p>:</span> <span class=n>Block</span><span class=p>,</span> <span class=n>new</span><span class=p>:</span> <span class=n>Block</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>string</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>event</span> <span class=o>==</span> <span class=s2>&#34;mining&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Update</span><span class=p>(</span><span class=n>state</span><span class=o>=</span><span class=n>new</span><span class=p>,</span> <span class=n>share</span><span class=o>=</span><span class=p>[</span><span class=n>new</span><span class=p>])</span>  <span class=c1># implicitly: append = []</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>new</span><span class=o>.</span><span class=n>height</span> <span class=o>&gt;</span> <span class=n>old</span><span class=o>.</span><span class=n>height</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Update</span><span class=p>(</span><span class=n>state</span><span class=o>=</span><span class=n>new</span><span class=p>)</span>  <span class=c1># implicitly: share &amp; append = []</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Update</span><span class=p>(</span><span class=n>state</span><span class=o>=</span><span class=n>old</span><span class=p>)</span>
</span></span></code></pre></div><figcaption>In <a href=/cpr/docs/protocols/nakamoto/>Nakamoto consensus</a> nodes always prefer
the longest chain of blocks, measured by block-height. Newly mined
blocks are shared immediately with the other participants.</figcaption></figure><p><code>mining</code> defines what the node appends if successful at proof-of-work.
The function takes as argument the current state of a node and returns
the block that the node wants to mine on. The engineer who implements
the specification and the protocol analyst interpret this function
differently.</p><p>The engineer will implement a proof-of-work loop that each node runs
locally in the background. For each iteration of the loop, the node
takes the latest block proposal from the <code>mining</code> function, slightly
permutes it, calculates its hash, and checks whether the hash meets the
mining difficulty target. If yes, the block now has a proof-of-work and
becomes valid. The node handles the new block according to the
specification&rsquo;s <code>update</code> function.</p><p>The <a href=../virtual-environment#proof-of-work>analyst avoids doing the actual
proof-of-work</a> and just assumes
that random nodes succeed with mining at random times. Only when a node
succeeds, the analyst obtains a block from the <code>mining</code> function, sets
its <code>has_pow()</code> property to true, and updates the node with the newly
appended block.</p><p>The protocol designer is indifferent to this distinction. She assumes
that</p><ul><li><code>b.has_pow()</code> is true if and only if <code>b</code> was appended through
proof-of-work, and</li><li>when a node learns about a successful proof-of-work with
<code>update(old_state, new_block, event = "mining")</code> it holds that
<code>new_block == mining(old_state)</code>.</li></ul><figure style=width:100%><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>mining</span><span class=p>(</span><span class=n>b</span><span class=p>:</span> <span class=n>Block</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Block</span><span class=p>(</span><span class=n>height</span><span class=o>=</span><span class=n>b</span><span class=o>.</span><span class=n>height</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>parents</span><span class=o>=</span><span class=p>[</span><span class=n>b</span><span class=p>],</span> <span class=n>miner</span><span class=o>=</span><span class=n>Env</span><span class=o>.</span><span class=n>my_id</span><span class=p>)</span>
</span></span></code></pre></div><figcaption>In <a href=/cpr/docs/protocols/nakamoto/>Nakamoto consensus</a> all blocks require
a proof-of-work. Nodes mine to append new blocks to their preferred tip
of the chain. Miners include their ID to facilitate disbursement of
mining rewards.</figcaption></figure><h2 id=difficulty-adjustment>Difficulty Adjustment <a href=#difficulty-adjustment class=anchor aria-hidden=true>#</a></h2><p>Proof-of-work intentionally slows down the creation of new blocks and
hence the growth of the blockchain. Typical proof-of-work protocols try
to maintain a constant growth rate. For example, Bitcoin tries to
achieve 6 blocks per hour, by updating the proof-of-work puzzle
difficulty every 2016 blocks. We use the term difficulty adjustment (DA)
to refer to the general problem of controlling chain growth.
Concrete DA mechanisms are called difficulty adjustment algorithms
(DAA).</p><p>Designing DAAs is quite challenging. A good DAA reacts quickly and
correctly to changes in the networks <em>true</em> hash-rate. Unfortunately,
the true hash-rate cannot be observed. In practice, nodes add a
timestamp to each block. The DAA then estimates the current hash-rate
from past timestamps. From there it deterministically adjusts the
difficulty for future blocks. In this scheme, there are many sources of
error. First, mining is a stochastic process. Puzzle solving times are
exponentially distributed, implying high variance. Observations of
puzzle solving time are noisy. Second, nodes are distributed around the
planet and might disagree about the current time. Third, nodes might try
to intentionally confuse the DAA by lying about the current time. Forth,
timestamps in orphaned blocks cannot be used. In short, difficulty
adjustment is a complex control problem. It even has its own line of
research.</p><p>Luckily, DA is somewhat orthogonal to consensus. In practice,
proof-of-work protocols require a DAA but in theory can often get away
without. Depending on the analysis, we either assume that the true
hash-rate is constant and known or we assume that the DAA does a perfect
job. To support the latter, protocols designers have to specify what
kind of growth the DAA should control for. In Bitcoin, the growth rate
equals increase in block height per time. Other protocols might choose a
different metric.</p><p>The protocol specification defines a single function <code>progress</code> that
maps a given block (tip of blockchain) to a scalar value. The engineer
implementing the protocol will contribute a DAA that controls for
constant progress per time. The analyst sometimes assumes constant
progress per time.</p><figure style=width:100%><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>progress</span><span class=p>(</span><span class=n>b</span><span class=p>:</span> <span class=n>Block</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>b</span><span class=o>.</span><span class=n>height</span>
</span></span></code></pre></div><figcaption><a href=../nakamoto>Nakamoto consensus</a> uses the block height as progress. The
DAA tries to achieve constant progress per time. Bitcoin targets 6
blocks per hour.</figcaption></figure><h2 id=rewards>Rewards <a href=#rewards class=anchor aria-hidden=true>#</a></h2><p>Deployed blockchain protocols usually implement some sort of virtual
currency. Funds are associated with cryptographic key-pairs. Moving
funds from one key-pair to another requires access to the source
key-pair&rsquo;s private part. This introduces a new kind of system
participant, namely the holders of the private keys and hence
<em>&#171;owners&#187;</em> of the associated funds. We call them crypto-currency
users.</p><p>In principle, crypto-currency users and node operators can be disjunct.
Users may operate a node but they do not have to. But in practice,
blockchain protocols motivate participation as operator by handing out
crypto-currency denoted rewards. Hence node operators usually are
crypto-currency users.</p><p>As protocol designers, we want our protocol to accommodate as many
applications as possible. We avoid imposing requirements on the
crypto-currency. We just assume that each node has access to a unique
identifier <code>my_id</code> that can receive rewards. In practice, <code>my_id</code> would
be the account or wallet address of the node&rsquo;s operator. The
specification itself however does not have any notion of crypto-currency
address or wallet.</p><p>We specify reward calculation using four functions <code>local_tip</code>, <code>global_tip</code>,
<code>history</code> and <code>reward</code>.</p><ul><li><code>local_tip</code> takes a node&rsquo;s state as argument and returns its preferred
tip of the chain.</li><li><code>global_tip</code> selects the impartially best tip among all nodes&rsquo; preferred
tips.</li><li><code>history</code> calculates the linear history of the best tip.</li><li><code>reward</code> maps a block (in the linear history) to reward assignments.</li><li>A reward assignment assigns a scalar reward to a node id.</li></ul><figure style=width:100%><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>local_tip</span><span class=p>(</span><span class=n>b</span><span class=p>:</span> <span class=n>Block</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>global_tip</span><span class=p>(</span><span class=n>l</span><span class=p>:</span> <span class=p>[</span><span class=n>Block</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>=</span> <span class=n>l</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>l</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>l</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>height</span> <span class=o>&gt;</span> <span class=n>b</span><span class=o>.</span><span class=n>height</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>b</span> <span class=o>=</span> <span class=n>l</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>history</span><span class=p>(</span><span class=n>b</span><span class=p>:</span> <span class=n>Block</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=p>[</span><span class=n>b</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>b</span><span class=o>.</span><span class=n>parents</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>p</span> <span class=o>!=</span> <span class=p>[]:</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=o>=</span> <span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>parents</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>h</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>reward</span><span class=p>(</span><span class=n>b</span><span class=p>:</span> <span class=n>Block</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>Reward</span><span class=p>(</span><span class=n>b</span><span class=o>.</span><span class=n>miner</span><span class=p>,</span> <span class=mi>1</span><span class=p>)]</span>
</span></span></code></pre></div><figcaption>In <a href=/cpr/docs/protocols/nakamoto/>Nakamoto consensus</a> the node&rsquo;s state is
its preferred tip of the chain. The best tip is the longest chain. The
history is the blockchain itself and the rewards are constant.</figcaption></figure><p>Splitting reward calculation into these four functions enables us to
calculate different useful metrics like</p><ul><li>subjective rewards for each node,</li><li>objective rewards in case of disagreement,</li><li>individual rewards for each block, and</li><li>accumulated historic rewards per node for any tip of the chain.</li></ul><p>The reward API can model situations where miners get assigned rewards
for blocks that are not part of the linear history. This happens for
example in <a href=/cpr/docs/protocols/parallel-tree/>tree-structured voting</a>.</p><div class="page-footer-meta d-flex flex-column flex-md-row justify-content-between"><div class=last-modified><a href=https://github.com/pkel/cpr/commit/4adcb522675328d054610cc1ddf855eaa2988b42><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Last modified on December 22, 2022</a></div><div class=edit-page><a href=https://github.com/pkel/cpr/blob/website/website/content/en/docs/methods/protocol-specification.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></div></div><div class="docs-navigation d-flex justify-content-between"><a href=/cpr/docs/methods/virtual-environment/><div class="card my-1"><div class="card-body py-2">&larr; Virtual Environment</div></div></a><a class=ms-auto href=/cpr/docs/methods/simulator/><div class="card my-1"><div class="card-body py-2">Simulator &rarr;</div></div></a></div></main></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a class=text-muted href=https://gohugo.io/>Hugo</a> and <a class=text-muted href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=/cpr/js/bootstrap.min.87685cf4e6585276ff9e7b5d0b97e792615af6921e77821315d1ca7c5511ac2f30667e16c0d031e680ca8b57f63f6c0f6c4a232da777cce474b501ed81e090a9.js integrity="sha512-h2hc9OZYUnb/nntdC5fnkmFa9pIed4ITFdHKfFURrC8wZn4WwNAx5oDKi1f2P2wPbEojLad3zOR0tQHtgeCQqQ==" crossorigin=anonymous defer></script>
<script src=/cpr/js/highlight.min.56a414730f1135fe77b5ea30bf74a2cc4101a6f386e85e5b789c800570cc33d33054000f45932c053a59b41018f72687867254a80e1b9710671852492533162f.js integrity="sha512-VqQUcw8RNf53teowv3SizEEBpvOG6F5beJyABXDMM9MwVAAPRZMsBTpZtBAY9yaHhnJUqA4blxBnGFJJJTMWLw==" crossorigin=anonymous defer></script>
<script src=/cpr/js/vendor/katex/dist/katex.min.ed3f25b49c13f756d6454d3bfdc2090afae6101a06312e6bd27f154380b31c955bb4615215ef7518b270b4f9013bc757ffa2587509afd55cbf98bdd4e06064b3.js integrity="sha512-7T8ltJwT91bWRU07/cIJCvrmEBoGMS5r0n8VQ4CzHJVbtGFSFe91GLJwtPkBO8dX/6JYdQmv1Vy/mL3U4GBksw==" crossorigin=anonymous defer></script>
<script src=/cpr/js/vendor/katex/dist/contrib/auto-render.min.f128dc24877a8ff5cdc694570f6cd25f8ad512d4330c242487c4cbbc5dc6fd2c52de778da1e59f98585d1defd5aa5aa583da59e90e6837973ecca3b45b01fb64.js integrity="sha512-8SjcJId6j/XNxpRXD2zSX4rVEtQzDCQkh8TLvF3G/SxS3neNoeWfmFhdHe/Vqlqlg9pZ6Q5oN5c+zKO0WwH7ZA==" crossorigin=anonymous defer></script>
<script src=/cpr/main.min.dcd3405902a4381167a9b62eb3f84939ffa863717d14f9ad3d6ac60715885caacc14864978ab396dca37cd3c69d903d955c44c33896c13f3ff6f7609fb10215f.js integrity="sha512-3NNAWQKkOBFnqbYus/hJOf+oY3F9FPmtPWrGBxWIXKrMFIZJeKs5bco3zTxp2QPZVcRMM4lsE/P/b3YJ+xAhXw==" crossorigin=anonymous defer></script>
<script src=https://pkel.github.io/cpr/index.min.f930599952ab2da36d9e4a135a5bd0e3c530efa1452bbebc6999e5898239c17f82f38ecfac47925f572eb5498a40bcafd0ee3a8175ac10f16d2378cdfdaabb1e.js integrity="sha512-+TBZmVKrLaNtnkoTWlvQ48Uw76FFK768aZnliYI5wX+C847PrEeSX1cutUmKQLyv0O46gXWsEPFtI3jN/aq7Hg==" crossorigin=anonymous defer></script></body></html>